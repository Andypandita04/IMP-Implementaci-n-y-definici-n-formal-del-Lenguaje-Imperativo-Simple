module Lexer where

import Data.Char

--Los constructores
data Token = TkDouble Double
           | TkSuma
           | TkResta
           | TkDiv
           | TkMult
           | TkParOpen
           | TkParClose
           | TkMenor
           | TkMayor
           | TkIgual
           | TkAnd
           | TkOr
           | TkNot
           | TkTrue  
           | TkFalse 
           | TkAsig
           | TkSeq
           | TkIf
           | TkThen
           | TkElse
           | TkWhile
           | TkDo
           | TkId

doubleSpan :: String -> (String, String)
doubleSpan xs = 
    if null siguientesDigitos 
    then (primerosDigitos, resto1)
    else (primerosDigitos ++ siguientesDigitos ++ epsilon, resto3)
  where
    (primerosDigitos, resto1) = span isDigit xs
    (siguientesDigitos, resto2) = case resto1 of
      ('.':ys) -> let (ds, restoYS) = span isDigit ys in ('.':ds, restoYS)
      _        -> ([], resto1)

    (epsilon, resto3) = case resto2 of
      ('e':ys) -> 
          let (signoExp, restoExp) = case ys of
                                       ('+':rest) -> ('+', rest)
                                       ('-':rest) -> ('-', rest)
                                       _          -> (' ', ys)  -- No hay signo, seguir con ys
              (ds, restoFinal) = span isDigit restoExp 
          in (signoExp:ds, restoFinal)
      _            -> ([], resto2)





lexer :: String -> [Token]
lexer [] = []
lexer (c:cs)
    | isSpace c = lexer cs -- Ignorar espacios en blanco
    | isDigit c = let (num, rest) = doubleSpan (c:cs)
                  in TkDouble (read num) : lexer rest
lexer ('+' : xs) = TkSuma : lexer xs
lexer ('-' : xs) = TkResta : lexer xs
lexer ('/' : xs) = TkDiv : lexer xs
lexer ('*' : xs) = TkMult : lexer xs
lexer ('(':xs ) = TkParOpen: lexer xs
lexer (')':xs ) = TkParClose: lexer xs
lexer('>' : xs) = TkMayor : lexer xs 
lexer('<' : xs) =  TkMenor : lexer xs
lexer('=' : xs) = TkIgual : lexer xs
lexer('a' : 'n' : 'd' : xs) = TkAnd : lexer xs
lexer('o' : 'r' :  xs) = TkOr : lexer xs
lexer('n' : 'o' : 't' :  xs) = TkNot : lexer xs
lexer('t':'r':'u':'e': xs) = TkTrue  : lexer xs
lexer('f':'a':'l':'s':'e': xs) = TkFalse  : lexer xs
lexer ( ':' : '=' : xs) = TkAsig : lexer xs
lexer (';' : xs) = TkSeq : lexer xs
lexer ('i' : 'f' : xs) = TkIf : lexer xs
lexer('t' : 'h' : 'e' : 'n' :  xs) = TkThen : lexer xs
lexer('e' : 'l' : 's' : 'e' :  xs) = TkElse : lexer xs
lexer('w' : 'h' : 'i' : 'l' : 'e' :  xs) = TkWhile : lexer xs
lexer ( 'd' : 'o' : xs) = TkDo : lexer xs
lexer _ = error "Tk desconocido"


instance Show Token where
  show (TkDouble d) =  show d
  show TkSuma       = "+"
  show TkResta      = "-"
  show TkDiv        = "/"
  show TkMult       = "*"
  show TkParOpen    = "("
  show TkParClose   = ")"
  show TkMenor      = "<"
  show TkMayor      = ">"
  show TkIgual      = "="
  show TkAnd        = "and"
  show TkOr         = "or"
  show TkNot        = "not"
  show TkTrue       = "true"
  show TkFalse      = "false"
  show TkAsig       = ":="
  show TkSeq        = ";"
  show TkIf         = "if"
  show TkThen       = "then"
  show TkElse       = "else"
  show TkWhile      = "while"
  show TkDo         = "do"